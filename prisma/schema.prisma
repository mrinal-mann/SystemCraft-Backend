// Prisma Schema for System Design Mentor
// Database: PostgreSQL
// ORM: Prisma Client Python

generator client {
    provider             = "prisma-client-py"
    recursive_type_depth = 5
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============== User Model ==============
// Represents registered users of the platform
model User {
    id             Int      @id @default(autoincrement())
    email          String   @unique
    hashedPassword String   @map("hashed_password")
    fullName       String?  @map("full_name")
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    // Relationships
    projects Project[]

    @@map("users")
}

// ============== Project Model ==============
// Represents a system design project created by a user
model Project {
    id          Int           @id @default(autoincrement())
    title       String
    description String?
    status      ProjectStatus @default(DRAFT)
    ownerId     Int           @map("owner_id")
    createdAt   DateTime      @default(now()) @map("created_at")
    updatedAt   DateTime      @updatedAt @map("updated_at")

    // Maturity Score (Step 3)
    maturityScore  Int     @default(0) @map("maturity_score")
    maturityReason String? @map("maturity_reason")

    // Relationships
    owner          User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
    designDetails  DesignDetails?
    designVersions DesignVersion[]
    suggestions    Suggestion[]

    @@map("projects")
}

// ============== Design Details Model ==============
// Stores the CURRENT low-level design (LLD) content for a project
// One-to-one relationship with Project
model DesignDetails {
    id        Int      @id @default(autoincrement())
    content   String   @default("")
    version   Int      @default(1)
    projectId Int      @unique @map("project_id")
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relationship
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@map("design_details")
}

// ============== Design Version Model (Step 1) ==============
// Stores historical snapshots of design content
// Every edit creates a new version for tracking progress
model DesignVersion {
    id            Int      @id @default(autoincrement())
    versionNumber Int      @map("version_number")
    content       String
    projectId     Int      @map("project_id")
    createdAt     DateTime @default(now()) @map("created_at")

    // Snapshot of maturity at this version
    maturityScore    Int @default(0) @map("maturity_score")
    suggestionsCount Int @default(0) @map("suggestions_count")

    // Relationship
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([projectId, versionNumber])
    @@map("design_versions")
}

// ============== Suggestion Model ==============
// Stores improvement suggestions generated by analysis
model Suggestion {
    id            Int                @id @default(autoincrement())
    title         String
    description   String
    category      SuggestionCategory @default(GENERAL)
    severity      SuggestionSeverity @default(INFO)
    designVersion Int                @default(1) @map("design_version")
    projectId     Int                @map("project_id")
    createdAt     DateTime           @default(now()) @map("created_at")

    // Suggestion Status (Step 2)
    status             SuggestionStatus @default(OPEN)
    addressedAt        DateTime?        @map("addressed_at")
    addressedInVersion Int?             @map("addressed_in_version")

    // Keywords that triggered this suggestion (for auto-detection)
    triggerKeywords String[] @default([]) @map("trigger_keywords")

    // Relationship
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@map("suggestions")
}

// ============== Enums ==============

enum ProjectStatus {
    DRAFT
    IN_PROGRESS
    ANALYZED
}

enum SuggestionCategory {
    CACHING
    SCALABILITY
    SECURITY
    RELIABILITY
    PERFORMANCE
    DATABASE
    API_DESIGN
    GENERAL
}

enum SuggestionSeverity {
    INFO
    WARNING
    CRITICAL
}

// Suggestion Status (Step 2)
enum SuggestionStatus {
    OPEN
    ADDRESSED
    IGNORED
}
